{% extends "pm/home.html" %}

{% block content %}
<div class="container" style="margin-top:32px;">
    <div style="display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 32px;">
        <!-- Top Left: Income Distribution Pie Chart -->
        <div style="background: var(--panel-2); border-radius: var(--radius); padding: 24px;">
            <h2 style="margin-top:0;">ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î•Î¹ÏƒÎ¿Î´Î®Î¼Î±Ï„Î¿Ï‚</h2>
            <canvas id="incomePieChart" width="320" height="220"></canvas>
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script>
                const ctx = document.getElementById('incomePieChart').getContext('2d');
                const propertyLabels = [
                    {% for lease in leases %}
                        "{% if lease.property %}{{ lease.property.address }}{% else %}{{ lease.unit.nickname }} - {{ lease.unit.complex.address }}{% endif %}"{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ];
                const propertyIncome = [
                    {% for lease in leases %}
                        {{ lease.amount_paid|floatformat:2 }}{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ];
                new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: propertyLabels,
                        datasets: [{
                            data: propertyIncome,
                            backgroundColor: [
                                '#22d3ee', '#10b981', '#f59e0b', '#ef4444', '#6366f1', '#eab308', '#a3e635', '#f472b6'
                            ],
                        }]
                    },
                    options: {
                        plugins: {
                            legend: { position: 'bottom', labels: { color: '#e5e7eb' } }
                        }
                    }
                });
            </script>
        </div>

        <!-- Top Right: Latest Notifications -->
        <div style="background: var(--panel-2); border-radius: var(--radius); padding: 24px;">
            <h2 style="margin-top:0;">Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯ÎµÏ‚ Î•Î¹Î´Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹Ï‚</h2>
            {% if notifications %}
                {% for note in notifications|slice:":5" %}
                    <div class="notification-card">
                        <div class="notification-header">
                            <span class="notification-title">
                                {% if note.property %}{{ note.property.address }}{% else %}{{ note.unit.nickname }} - {{ note.unit.complex.address }}{% endif %}
                            </span>
                            <span style="float:right; font-size:12px; color:var(--muted);">{{ note.timestamp|date:"M d, H:i" }}</span>
                        </div>
                        <div class="notification-body">
                            <p class="notification-message">{{ note.content }}</p>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <p style="color:var(--muted);">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÎµÎ¹Î´Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹Ï‚.</p>
            {% endif %}
        </div>

        <!-- Bottom Left: Property Overview Spreadsheet -->
        <div style="background: var(--panel-2); border-radius: var(--radius); padding: 24px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h2 style="margin: 0;">Î•Ï€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ· Î‘ÎºÎ¹Î½Î®Ï„Ï‰Î½</h2>
                <div style="display: flex; gap: 8px;">
                    <button onclick="exportSpreadsheet()" style="background: var(--primary); color: #00303a; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600;" type="button">Î•Î¾Î±Î³Ï‰Î³Î® Î•ÏƒÏŒÎ´Ï‰Î½</button>
                    <button onclick="exportFinancialReport()" style="background: var(--success); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600;" type="button">ÎŸÎ¹ÎºÎ¿Î½Î¿Î¼Î¹ÎºÏŒÏ‚ Î‘Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚</button>
                </div>
            </div>
            
            <div style="max-height: 260px; overflow-y: auto;">
                <table id="propertySpreadsheet" style="width: 100%; border-collapse: collapse; font-size: 13px;">
                    <thead style="sticky; top: 0; background: var(--panel-1); z-index: 1;">
                        <tr>
                            <th style="text-align: left; padding: 8px; border-bottom: 2px solid rgba(255,255,255,.08);">Î‘ÎºÎ¯Î½Î·Ï„Î¿</th>
                            <th style="text-align: center; padding: 8px; border-bottom: 2px solid rgba(255,255,255,.08);">Î¤ÏÏ€Î¿Ï‚</th>
                            <th style="text-align: right; padding: 8px; border-bottom: 2px solid rgba(255,255,255,.08);">ÎœÎ·Î½Î¹Î±Î¯Î¿</th>
                            <th style="text-align: right; padding: 8px; border-bottom: 2px solid rgba(255,255,255,.08);">Î•Î¹ÏƒÏ€ÏÎ±Ï‡Î¸Î­Î½Ï„Î±</th>
                            <th style="text-align: center; padding: 8px; border-bottom: 2px solid rgba(255,255,255,.08);">ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for lease in leases %}
                            <tr style="border-bottom: 1px solid rgba(255,255,255,.06);">
                                <td style="padding: 8px;">
                                    <div style="font-weight: 500; margin-bottom: 2px;">
                                        {% if lease.property %}{{ lease.property.address }}{% else %}{{ lease.unit.nickname }}{% endif %}
                                    </div>
                                </td>
                                <td style="padding: 8px; text-align: center;">
                                    <span style="background: var(--panel-1); padding: 2px 6px; border-radius: 8px; font-size: 11px;">
                                        {% if lease.property %}{{ lease.property.property_type|capfirst }}{% else %}ÎœÎ¿Î½Î¬Î´Î±{% endif %}
                                    </span>
                                </td>
                                <td style="padding: 8px; text-align: right; font-weight: 500;">â‚¬{{ lease.monthly_payment_amount|floatformat:2 }}</td>
                                <td style="padding: 8px; text-align: right; color: var(--success);">â‚¬{{ lease.amount_paid|floatformat:2 }}</td>
                                <td style="padding: 8px; text-align: center;">
                                    <span class="status-badge status-{{ lease.monthly_payment_status }}">
                                        {{ lease.monthly_payment_status|capfirst }}
                                    </span>
                                </td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="5" style="padding: 24px; text-align: center; color: var(--muted);">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î± Î±ÎºÎ¯Î½Î·Ï„Î±</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Summary Row -->
            <div style="margin-top: 16px; padding: 12px; border-top: 2px solid rgba(255,255,255,.08); background: var(--panel-1); border-radius: 8px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; font-size: 13px;">
                    <div style="text-align: center;">
                        <div style="color: var(--muted); margin-bottom: 4px;">Î£ÏÎ½Î¿Î»Î¿ Î‘ÎºÎ¹Î½Î®Ï„Ï‰Î½</div>
                        <div style="font-weight: 600; color: var(--primary);">{{ leases|length }}</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="color: var(--muted); margin-bottom: 4px;">ÎœÎ·Î½Î¹Î±Î¯Î± ÎˆÏƒÎ¿Î´Î±</div>
                        <div style="font-weight: 600; color: var(--success);">â‚¬<span id="totalIncome">0.00</span></div>
                    </div>
                    <div style="text-align: center;">
                        <div style="color: var(--muted); margin-bottom: 4px;">Î£Ï…Î½Î¿Î»Î¹ÎºÎ¬ Î•Î¹ÏƒÏ€ÏÎ±Ï‡Î¸Î­Î½Ï„Î±</div>
                        <div style="font-weight: 600; color: var(--text);">â‚¬<span id="totalCollected">0.00</span></div>
                    </div>
                </div>
            </div>
            <a href="{% url 'expenses' %}" style="display:inline-block; margin-top:12px; color:var(--primary); text-decoration:none;">Î ÏÎ¿Î²Î¿Î»Î® Î•Î¾ÏŒÎ´Ï‰Î½</a>
            
            <!-- Recent Expenses Overview -->
            <div style="margin-top: 24px; padding-top: 20px; border-top: 2px solid rgba(255,255,255,.08);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h3 style="margin: 0; font-size: 16px; color: var(--text);">Î ÏÏŒÏƒÏ†Î±Ï„Î± ÎˆÎ¾Î¿Î´Î±</h3>
                    <span style="font-size: 12px; color: var(--muted);">Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯Î± 10 Î­Î¾Î¿Î´Î±</span>
                </div>
                
                {% if recent_expenses %}
                    <div style="max-height: 240px; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <thead style="position: sticky; top: 0; background: var(--panel-1); z-index: 1;">
                                <tr>
                                    <th style="text-align: left; padding: 6px; border-bottom: 1px solid rgba(255,255,255,.08); font-size: 11px; color: var(--muted);">Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±</th>
                                    <th style="text-align: left; padding: 6px; border-bottom: 1px solid rgba(255,255,255,.08); font-size: 11px; color: var(--muted);">Î‘ÎºÎ¯Î½Î·Ï„Î¿</th>
                                    <th style="text-align: left; padding: 6px; border-bottom: 1px solid rgba(255,255,255,.08); font-size: 11px; color: var(--muted);">ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±</th>
                                    <th style="text-align: left; padding: 6px; border-bottom: 1px solid rgba(255,255,255,.08); font-size: 11px; color: var(--muted);">Î ÎµÏÎ¹Î³ÏÎ±Ï†Î®</th>
                                    <th style="text-align: right; padding: 6px; border-bottom: 1px solid rgba(255,255,255,.08); font-size: 11px; color: var(--muted);">Î Î¿ÏƒÏŒ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for expense in recent_expenses %}
                                    <tr style="border-bottom: 1px solid rgba(255,255,255,.04);">
                                        <td style="padding: 6px; font-size: 11px;">{{ expense.date|date:"M d" }}</td>
                                        <td style="padding: 6px; font-size: 11px;">
                                            {% if expense.property %}
                                                {{ expense.property.address|truncatechars:20 }}
                                            {% else %}
                                                {{ expense.unit.nickname|truncatechars:15 }}
                                            {% endif %}
                                        </td>
                                        <td style="padding: 6px;">
                                            <span style="background: var(--panel); padding: 1px 4px; border-radius: 4px; font-size: 10px; text-transform: capitalize;">
                                                {{ expense.get_category_display|truncatechars:10 }}
                                            </span>
                                        </td>
                                        <td style="padding: 6px; font-size: 11px;">{{ expense.description|truncatechars:25 }}</td>
                                        <td style="padding: 6px; text-align: right; font-weight: 500; color: var(--danger); font-size: 11px;">
                                            â‚¬{{ expense.amount|floatformat:2 }}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Expenses Summary -->
                    <div style="margin-top: 12px; padding: 8px 12px; background: var(--panel-1); border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 11px; color: var(--muted);">Î£ÏÎ½Î¿Î»Î¿ Î ÏÏŒÏƒÏ†Î±Ï„Ï‰Î½ Î•Î¾ÏŒÎ´Ï‰Î½:</span>
                        <span style="font-weight: 600; color: var(--danger); font-size: 12px;" id="totalRecentExpenses">â‚¬0.00</span>
                    </div>
                {% else %}
                    <div style="padding: 20px; text-align: center; color: var(--muted); background: var(--panel-1); border-radius: 6px;">
                        <div style="font-size: 24px; margin-bottom: 8px; opacity: 0.5;">ğŸ’°</div>
                        <div style="font-size: 12px;">Î”ÎµÎ½ Î­Ï‡Î¿Ï…Î½ ÎºÎ±Ï„Î±Î³ÏÎ±Ï†ÎµÎ¯ Î­Î¾Î¿Î´Î± Î±ÎºÏŒÎ¼Î±</div>
                        <a href="{% url 'expenses' %}" style="color: var(--primary); text-decoration: none; font-size: 11px; margin-top: 4px; display: inline-block;">Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Ï€ÏÏÏ„Î·Ï‚ ÎµÎ¾ÏŒÎ´Î¿Ï…</a>
                    </div>
                {% endif %}
            </div>
        </div>

        <script>
            // Simple calculations and export - minimal JS
            document.addEventListener('DOMContentLoaded', function() {
                let totalIncome = 0, totalCollected = 0;
                {% for lease in leases %}
                    totalIncome += {{ lease.monthly_payment_amount }};
                    totalCollected += {{ lease.amount_paid }};
                {% endfor %}
                document.getElementById('totalIncome').textContent = totalIncome.toFixed(2);
                document.getElementById('totalCollected').textContent = totalCollected.toFixed(2);
                
                // Calculate recent expenses total
                let totalRecentExpenses = 0;
                {% for expense in recent_expenses %}
                    totalRecentExpenses += {{ expense.amount }};
                {% endfor %}
                const expensesElement = document.getElementById('totalRecentExpenses');
                if (expensesElement) {
                    expensesElement.textContent = 'â‚¬' + totalRecentExpenses.toFixed(2);
                }
            });
        </script>        <!-- Bottom Right: Payments Due -->
        <div style="background: var(--panel-2); border-radius: var(--radius); padding: 24px;">
            <h2 style="margin-top:0;">Î Î»Î·ÏÏ‰Î¼Î­Ï‚ Ï€ÏÎ¿Ï‚ Î•Î¯ÏƒÏ€ÏÎ±Î¾Î·</h2>
            {% with due_leases=leases|dictsort:"monthly_payment_status" %}
                {% if leases %}
                    <table style="width:100%; border-collapse:collapse;">
                        <thead>
                            <tr style="color:var(--muted); font-size:14px;">
                                <th style="text-align:left; padding:6px;">Î‘ÎºÎ¯Î½Î·Ï„Î¿</th>
                                <th style="text-align:left; padding:6px;">Î•Î½Î¿Î¹ÎºÎ¹Î±ÏƒÏ„Î­Ï‚</th>
                                <th style="text-align:left; padding:6px;">ÎŸÏ†ÎµÎ¹Î»ÏŒÎ¼ÎµÎ½Î¿ Î Î¿ÏƒÏŒ</th>
                                <th style="text-align:left; padding:6px;">ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for lease in leases %}
                                {% if lease.monthly_payment_status == 'pending' or lease.months_due > 0 %}
                                    <tr>
                                        <td style="padding:6px;">
                                            {% if lease.property %}{{ lease.property.address }}{% else %}{{ lease.unit.nickname }} - {{ lease.unit.complex.address }}{% endif %}
                                        </td>
                                        <td style="padding:6px;">
                                            {% for tenant in lease.tenant.all %}
                                                {{ tenant.get_full_name|default:tenant.username }}{% if not forloop.last %}, {% endif %}
                                            {% endfor %}
                                        </td>
                                        <td style="padding:6px;">
                                            â‚¬{{ lease.monthly_payment_amount|floatformat:2 }}
                                            {% if lease.months_due > 0 %}
                                                <span style="color:var(--danger); font-size:13px;">({{ lease.months_due }} Î¼Î®Î½Î±{{ lease.months_due|pluralize:"Ï‚,ÎµÏ‚" }})</span>
                                            {% endif %}
                                        </td>
                                        <td style="padding:6px;">
                                            <span class="status {% if lease.monthly_payment_status == 'pending' %}available{% else %}rented{% endif %}">
                                                {{ lease.monthly_payment_status|capfirst }}
                                            </span>
                                        </td>
                                    </tr>
                                {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                    <a href="{% url "documents" %}" style="display:inline-block; margin-top:12px; color:var(--primary); text-decoration:none;">Î ÏÎ¿Î²Î¿Î»Î® Î¥Ï€Î¿Î²Î»Î·Î¸ÎµÎ¹ÏƒÏÎ½ Î Î»Î·ÏÏ‰Î¼ÏÎ½</a>
                {% else %}
                    <p style="color:var(--muted);">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Ï€Î»Î·ÏÏ‰Î¼Î­Ï‚ Ï€ÏÎ¿Ï‚ ÎµÎ¯ÏƒÏ€ÏÎ±Î¾Î·.</p>
                {% endif %}
            {% endwith %}
        </div>
    </div>
</div>

<script>
// Global functions for CSV export
function parseAmount(amountText) {
    // Remove all non-numeric characters except decimal point
    const cleanAmount = amountText.replace(/[^\d.,]/g, '');
    // Handle European decimal format (comma as decimal separator)
    const normalizedAmount = cleanAmount.replace(',', '.');
    // Remove any extra dots except the last one
    const parts = normalizedAmount.split('.');
    if (parts.length > 2) {
        // If multiple dots, keep only the last one as decimal
        const integerPart = parts.slice(0, -1).join('');
        const decimalPart = parts[parts.length - 1];
        return parseFloat(integerPart + '.' + decimalPart) || 0;
    }
    return parseFloat(normalizedAmount) || 0;
}

function exportSpreadsheet() {
    try {
        const table = document.getElementById('propertySpreadsheet');
        if (!table) {
            alert('Î Î¯Î½Î±ÎºÎ±Ï‚ Î´ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ');
            return;
        }
        const rows = Array.from(table.rows);
        const csv = rows.map(row => 
            Array.from(row.cells).map(cell => 
                '"' + cell.textContent.trim().replace(/"/g, '""') + '"'
            ).join(',')
        ).join('\n');
        
        // Add BOM for Excel compatibility with Greek characters
        const BOM = '\uFEFF';
        const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'properties_' + new Date().toISOString().split('T')[0] + '.csv';
        a.click();
        URL.revokeObjectURL(url);
    } catch (error) {
        console.error('Export error:', error);
        alert('Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î·Î½ ÎµÎ¾Î±Î³Ï‰Î³Î®: ' + error.message);
    }
}

function exportFinancialReport() {
    try {
        // Create comprehensive financial report grouped by property
        let csv = [];
        
        // Header section
        csv.push('"ÎŸÎ¹ÎºÎ¿Î½Î¿Î¼Î¹ÎºÏŒÏ‚ Î‘Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚","' + new Date().toLocaleDateString('el-GR') + '","","","",""');
        csv.push('"","","","","",""');
        csv.push('"Î¤ÏÏ€Î¿Ï‚","Î¤ÏÏ€Î¿Ï‚/Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±","ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±","Î ÎµÏÎ¹Î³ÏÎ±Ï†Î®","Î Î¿ÏƒÏŒ","Î£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚"');
        csv.push('"","","","","",""');
        
        let grandTotalIncome = 0;
        let grandTotalExpenses = 0;
        const propertyData = {};
        
        // Get income data from property spreadsheet
        const propertyTable = document.getElementById('propertySpreadsheet');
        if (propertyTable) {
            const propertyRows = Array.from(propertyTable.rows).slice(1); // Skip header
            
            propertyRows.forEach(row => {
                const cells = Array.from(row.cells);
                if (cells.length >= 5) {
                    const property = cells[0].textContent.trim();
                    const propertyType = cells[1].textContent.trim();
                    const monthlyRent = cells[2].textContent.trim();
                    const collected = cells[3].textContent.trim();
                    const status = cells[4].textContent.trim();
                    
                    if (!propertyData[property]) {
                        propertyData[property] = {
                            income: [],
                            expenses: [],
                            totalIncome: 0,
                            totalExpenses: 0
                        };
                    }
                    
                    const collectedAmount = parseAmount(collected);
                    
                    if (collectedAmount > 0) {
                        propertyData[property].income.push({
                            type: 'ÎˆÏƒÎ¿Î´Î¿',
                            date: 'ÎœÎ·Î½Î¹Î±Î¯Î¿',
                            category: 'ÎœÎ¯ÏƒÎ¸Ï‰Î¼Î±',
                            description: `${property} (${propertyType})`,
                            amount: collectedAmount,
                            notes: `ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·: ${status}`
                        });
                        
                        propertyData[property].totalIncome += collectedAmount;
                        grandTotalIncome += collectedAmount;
                    }
                }
            });
        }
        
        // Get expenses data from recent expenses table
        const expenseTables = document.querySelectorAll('table');
        expenseTables.forEach(table => {
            const headerCells = table.querySelectorAll('th');
            // Check if this is the expenses table by looking for specific headers
            const hasExpenseHeaders = Array.from(headerCells).some(th => 
                th.textContent.includes('Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±') && 
                Array.from(headerCells).some(th2 => th2.textContent.includes('ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±'))
            );
            
            if (hasExpenseHeaders) {
                const expenseRows = Array.from(table.rows).slice(1); // Skip header
                
                expenseRows.forEach(row => {
                    const cells = Array.from(row.cells);
                    if (cells.length >= 5) {
                        const date = cells[0].textContent.trim();
                        const property = cells[1].textContent.trim();
                        const category = cells[2].textContent.trim();
                        const description = cells[3].textContent.trim();
                        const amount = cells[4].textContent.trim();
                        
                        // Skip if this doesn't look like a valid expense row
                        if (!date || !property || !amount.includes('â‚¬')) return;
                        
                        if (!propertyData[property]) {
                            propertyData[property] = {
                                income: [],
                                expenses: [],
                                totalIncome: 0,
                                totalExpenses: 0
                            };
                        }
                        
                        const expenseAmount = parseAmount(amount);
                        
                        if (expenseAmount > 0) {
                            propertyData[property].expenses.push({
                                type: 'ÎˆÎ¾Î¿Î´Î¿',
                                date: date,
                                category: category,
                                description: description,
                                amount: expenseAmount,
                                notes: ''
                            });
                            
                            propertyData[property].totalExpenses += expenseAmount;
                            grandTotalExpenses += expenseAmount;
                        }
                    }
                });
            }
        });
        
        // If no properties found, add a note
        if (Object.keys(propertyData).length === 0) {
            csv.push('"Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Î±","","","","",""');
            csv.push('"Î’ÎµÎ²Î±Î¹Ï‰Î¸ÎµÎ¯Ï„Îµ ÏŒÏ„Î¹ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±ÎºÎ¯Î½Î·Ï„Î± ÎºÎ±Î¹ Î­Î¾Î¿Î´Î± ÏƒÏ„Î· ÏƒÎµÎ»Î¯Î´Î±","","","","",""');
        } else {
            // Output data grouped by property
            Object.keys(propertyData).forEach(propertyName => {
                const data = propertyData[propertyName];
                
                // Property header
                csv.push(`"=== ${propertyName} ===","","","","",""`);
                
                // Income entries for this property
                if (data.income.length > 0) {
                    csv.push('"--- ÎˆÎ£ÎŸÎ”Î‘ ---","","","","",""');
                    data.income.forEach(item => {
                        csv.push(`"${item.type}","${item.date}","${item.category}","${item.description}","â‚¬${item.amount.toFixed(2)}","${item.notes}"`);
                    });
                    csv.push(`"Î£ÏÎ½Î¿Î»Î¿ Î•ÏƒÏŒÎ´Ï‰Î½","","","","â‚¬${data.totalIncome.toFixed(2)}",""`);
                    csv.push('"","","","","",""');
                }
                
                // Expenses entries for this property
                if (data.expenses.length > 0) {
                    csv.push('"--- Î•ÎÎŸÎ”Î‘ ---","","","","",""');
                    data.expenses.forEach(item => {
                        csv.push(`"${item.type}","${item.date}","${item.category}","${item.description}","â‚¬${item.amount.toFixed(2)}","${item.notes}"`);
                    });
                    csv.push(`"Î£ÏÎ½Î¿Î»Î¿ Î•Î¾ÏŒÎ´Ï‰Î½","","","","â‚¬${data.totalExpenses.toFixed(2)}",""`);
                    csv.push('"","","","","",""');
                }
                
                // Property net result
                const netResult = data.totalIncome - data.totalExpenses;
                csv.push(`"ÎšÎ±Î¸Î±ÏÏŒ Î‘Ï€Î¿Ï„Î­Î»ÎµÏƒÎ¼Î±","","","","â‚¬${netResult.toFixed(2)}","${netResult >= 0 ? 'ÎšÎ­ÏÎ´Î¿Ï‚' : 'Î–Î·Î¼Î¯Î±'}"`);
                csv.push('"","","","","",""'); // Empty line between properties
            });
            
            // Grand totals
            csv.push('"=== Î£Î¥ÎÎŸÎ›Î™ÎšÎŸÎ£ Î‘Î ÎŸÎ›ÎŸÎ“Î™Î£ÎœÎŸÎ£ ===","","","","",""');
            csv.push(`"Î£Ï…Î½Î¿Î»Î¹ÎºÎ¬ ÎˆÏƒÎ¿Î´Î±","","","","â‚¬${grandTotalIncome.toFixed(2)}",""`);
            csv.push(`"Î£Ï…Î½Î¿Î»Î¹ÎºÎ¬ ÎˆÎ¾Î¿Î´Î±","","","","â‚¬${grandTotalExpenses.toFixed(2)}",""`);
            const grandNetResult = grandTotalIncome - grandTotalExpenses;
            csv.push(`"ÎšÎ±Î¸Î±ÏÏŒ Î£Ï…Î½Î¿Î»Î¹ÎºÏŒ Î‘Ï€Î¿Ï„Î­Î»ÎµÏƒÎ¼Î±","","","","â‚¬${grandNetResult.toFixed(2)}","${grandNetResult >= 0 ? 'Î£Ï…Î½Î¿Î»Î¹ÎºÏŒ ÎšÎ­ÏÎ´Î¿Ï‚' : 'Î£Ï…Î½Î¿Î»Î¹ÎºÎ® Î–Î·Î¼Î¯Î±'}"`);
        }
        
        // Create and download file
        const BOM = '\uFEFF';
        const blob = new Blob([BOM + csv.join('\n')], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'financial_report_' + new Date().toISOString().split('T')[0] + '.csv';
        a.click();
        URL.revokeObjectURL(url);
    } catch (error) {
        console.error('Financial report export error:', error);
        alert('Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î·Î½ ÎµÎ¾Î±Î³Ï‰Î³Î® Î¿Î¹ÎºÎ¿Î½Î¿Î¼Î¹ÎºÎ¿Ï Î±Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼Î¿Ï: ' + error.message);
    }
}
</script>

{% endblock content %}